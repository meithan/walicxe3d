<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Walicxe3D: source/boundary.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>source/boundary.f90</h1><a href="boundary_8f90.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">!===============================================================================</span><span class="comment"></span>
<a name="l00002"></a>00002 !&gt; @file boundary.f90
<a name="l00003"></a>00003 !&gt; @brief Fills ghost cells by calculating or passing block boundaries
<a name="l00004"></a>00004 !&gt; @author Juan C. Toledo
<a name="l00005"></a>00005 !&gt; @date 20/Feb/2012
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">! Copyright (c) 2012 Alejandro Esquivel and Juan C. Toledo</span>
<a name="l00008"></a>00008 <span class="comment">!</span>
<a name="l00009"></a>00009 <span class="comment">! This file is part of Walicxe3D.</span>
<a name="l00010"></a>00010 <span class="comment">!</span>
<a name="l00011"></a>00011 <span class="comment">! Walicxe3D is free software; you can redistribute it and/or modify</span>
<a name="l00012"></a>00012 <span class="comment">! it under the terms of the GNU General Public License as published by</span>
<a name="l00013"></a>00013 <span class="comment">! the Free Software Foundation; either version 3 of the License, or</span>
<a name="l00014"></a>00014 <span class="comment">! (at your option) any later version.</span>
<a name="l00015"></a>00015 <span class="comment">!</span>
<a name="l00016"></a>00016 <span class="comment">! This program is distributed in the hope that it will be useful,</span>
<a name="l00017"></a>00017 <span class="comment">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00018"></a>00018 <span class="comment">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<a name="l00019"></a>00019 <span class="comment">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<a name="l00020"></a>00020 <span class="comment">! GNU General Public License for more details.</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="comment">! You should have received a copy of the GNU General Public License</span>
<a name="l00023"></a>00023 <span class="comment">! along with this program.  If not, see http://www.gnu.org/licenses/.</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="comment">!===============================================================================</span>
<a name="l00026"></a>00026 <span class="comment"></span>
<a name="l00027"></a>00027 !&gt; @brief Performs calculation and passing of block boundaries
<a name="l00028"></a>00028 !&gt; @details This routine exchanges the boundaries between blocks prior to
<a name="l00029"></a>00029 !! numerical integration. Simulation box boundaries are calculated locally,
<a name="l00030"></a>00030 !! while boundaries betwen blocks are passed via message.
<a name="l00031"></a>00031 !&gt; @param depth The number of layers of ghost cells that are to be passed
<a name="l00032"></a>00032 !&gt; @param uvars Vector of flow variables to be modified
<a name="l00033"></a><a class="code" href="boundary_8f90.html#a236deccc2a5c9c38ddf48adf49e5a60a">00033</a> <span class="keyword">subroutine </span><a class="code" href="boundary_8f90.html#a236deccc2a5c9c38ddf48adf49e5a60a">boundary</a> (depth, uvars)
<a name="l00034"></a>00034 
<a name="l00035"></a>00035   use <span class="keywordflow">globals</span>
<a name="l00036"></a>00036   use <span class="keywordflow">parameters</span>
<a name="l00037"></a>00037   use <span class="keywordflow">tictoc</span>
<a name="l00038"></a>00038   <span class="keyword">implicit none</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: depth
<a name="l00041"></a>00041   <span class="keywordtype">real</span>, <span class="keywordtype">intent(inout)</span> :: uvars(nbMaxProc, neqtot, nxmin:nxmax, nymin:nymax, nzmin:nzmax)
<a name="l00042"></a>00042 
<a name="l00043"></a>00043   <span class="keywordtype">integer</span> :: a, b, direction, nb, destID, destOwner, destInd, srcID, srcOwner
<a name="l00044"></a>00044   <span class="keywordtype">integer</span> :: srcInd, nData, src_face, depth1, ieq, shift, bc_type
<a name="l00045"></a>00045   <span class="keywordtype">integer</span> :: i, j, k, ip, jp, kp, i1, i2, i3, i4, j1, j2, j3, j4, k1, k2, k3, k4
<a name="l00046"></a>00046   <span class="keywordtype">integer</span> :: sx, sy, sz
<a name="l00047"></a>00047   <span class="keywordtype">integer</span> :: ntype, neighs(4), mark
<a name="l00048"></a>00048   <span class="keywordtype">integer</span> :: mpi_status(MPI_STATUS_SIZE), ierr
<a name="l00049"></a>00049   <span class="keywordtype">real</span> :: x_buf(neqtot, depth, ncells_y/2, ncells_z/2)
<a name="l00050"></a>00050   <span class="keywordtype">real</span> :: y_buf(neqtot, ncells_x/2, depth, ncells_z/2)
<a name="l00051"></a>00051   <span class="keywordtype">real</span> :: z_buf(neqtot, ncells_x/2, ncells_y/2, depth)
<a name="l00052"></a>00052   <span class="keywordtype">logical</span> :: verbose
<a name="l00053"></a>00053 
<a name="l00054"></a>00054   <span class="comment">! DEBUG</span>
<a name="l00055"></a>00055   verbose = .false.
<a name="l00056"></a>00056 
<a name="l00057"></a>00057   call <a class="code" href="namespacetictoc.html#ab092f042aab35f2f6928c7b2f073b116">tic</a>(mark)
<a name="l00058"></a>00058 
<a name="l00059"></a>00059   <span class="comment">! For all six directions, where direction indicates which ghost cell layer</span>
<a name="l00060"></a>00060   <span class="comment">! of the destination block if being set</span>
<a name="l00061"></a>00061   <span class="keyword">do</span> a=1,6
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="keyword">select</span> <span class="keyword">case</span> (a)
<a name="l00064"></a>00064     <span class="keyword">case</span> (1)
<a name="l00065"></a>00065       direction = LEFT
<a name="l00066"></a>00066       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 1: setting LEFT ghost cells&quot;</span>
<a name="l00067"></a>00067     <span class="keyword">case</span> (2)
<a name="l00068"></a>00068       direction = RIGHT
<a name="l00069"></a>00069       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 2: setting RIGHT ghost cells&quot;</span>      
<a name="l00070"></a>00070     <span class="keyword">case</span> (3)
<a name="l00071"></a>00071       direction = FRONT
<a name="l00072"></a>00072       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 3: setting FRONT ghost cells&quot;</span>      
<a name="l00073"></a>00073     <span class="keyword">case</span> (4)
<a name="l00074"></a>00074       direction = BACK
<a name="l00075"></a>00075       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 4: setting BACK ghost cells&quot;</span>      
<a name="l00076"></a>00076     <span class="keyword">case</span> (5)
<a name="l00077"></a>00077       direction = BOTTOM
<a name="l00078"></a>00078       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 5: setting BOTTOM ghost cells&quot;</span>
<a name="l00079"></a>00079     <span class="keyword">case</span> (6)
<a name="l00080"></a>00080       direction = TOP
<a name="l00081"></a>00081       <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Step 6: setting TOP ghost cells&quot;</span>      
<a name="l00082"></a>00082     <span class="keyword">end select</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">! For every active block ...</span>
<a name="l00085"></a>00085     <span class="keyword">do</span> nb=1,<a class="code" href="namespaceparameters.html#a9956bfd2c200d8b3dd24e4294ed11770">nbMaxGlobal</a>
<a name="l00086"></a>00086       destID = <a class="code" href="namespaceglobals.html#ae1b47be87361ae69b73a7cdc15511687">globalBlocks</a>(nb)
<a name="l00087"></a>00087       <span class="keyword">if</span> (destID.ne.-1) <span class="keyword">then</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         <span class="comment">! The following will set destID&#39;s ghost cells on the face along the</span>
<a name="l00090"></a>00090         <span class="comment">! direction in turn. The block is called the &quot;destination&quot;, while</span>
<a name="l00091"></a>00091         <span class="comment">! the neighbor(s) along this direction is(are) called the &quot;source&quot;.</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <span class="comment">! Obtain the this block&#39;s owner and neighbor(s) along the given direction</span>
<a name="l00094"></a>00094         call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(destID, destOwner)
<a name="l00095"></a>00095         call <a class="code" href="admesh_8f90.html#af94ac1ac28f8c4c52bc7687e51213eb6">neighbors </a>(destID, direction, ntype, neighs)
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00098"></a>00098           <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;&quot;</span>
<a name="l00099"></a>00099           <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(a,i8)&#39;</span>) <span class="stringliteral">&quot;Destination block: &quot;</span>, destID       
<a name="l00100"></a>00100           <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a,i4)&#39;</span>) <span class="stringliteral">&quot;Current owner: &quot;</span>, destOwner
<a name="l00101"></a>00101           <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a,i2)&#39;</span>) <span class="stringliteral">&quot;Neighbor Type: &quot;</span>, ntype
<a name="l00102"></a>00102           <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;Neighbor(s): &quot;</span>, neighs
<a name="l00103"></a>00103         <span class="keyword">end if</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         <span class="comment">! ====================== !</span>
<a name="l00106"></a>00106         <span class="comment">! Sender-side operations !</span>
<a name="l00107"></a>00107         <span class="comment">!  (MPI operations only) !</span>
<a name="l00108"></a>00108         <span class="comment">! ====================== !</span>
<a name="l00109"></a>00109         
<a name="l00110"></a>00110         <span class="keyword">if</span> (destOwner.ne.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00111"></a>00111           <span class="comment">! Only checked when destination block is *not* local</span>
<a name="l00112"></a>00112           <span class="comment">!</span>
<a name="l00113"></a>00113           <span class="comment">! If it is, this rank will never send boundary cells through MPI</span>
<a name="l00114"></a>00114           <span class="comment">! (nonlocal neighbor data will get sent by someone else, and local</span>
<a name="l00115"></a>00115           <span class="comment">! neighbor data is copied from local memory)</span>
<a name="l00116"></a>00116           
<a name="l00117"></a>00117           <span class="comment">! =================================</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119           <span class="comment">! Boundary to same-level block       </span>
<a name="l00120"></a>00120           
<a name="l00121"></a>00121           <span class="keyword">if</span> (ntype.eq.NEIGH_SAME) <span class="keyword">then</span>
<a name="l00122"></a>00122             srcID = neighs(1)
<a name="l00123"></a>00123             call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00124"></a>00124             <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00125"></a>00125 
<a name="l00126"></a>00126               <span class="comment">! Send full boundary through MPI</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128               call <a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite  </a>(direction, src_face)
<a name="l00129"></a>00129               call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(src_face, depth, .false., i1, i2, j1, j2, k1, k2)
<a name="l00130"></a>00130               call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00131"></a>00131 
<a name="l00132"></a>00132               nData = neqtot*(i2-i1+1)*(j2-j1+1)*(k2-k1+1)
<a name="l00133"></a>00133               call MPI_SEND ( uvars(srcInd, 1:neqtot, i1:i2, j1:j2, k1:k2), &amp;
<a name="l00134"></a>00134                nData, mpi_real_kind, destOwner, srcID, mpi_comm_world, ierr)
<a name="l00135"></a>00135 
<a name="l00136"></a>00136               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00137"></a>00137                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3,a,i6,a,i3)&#39;</span>) srcID, &amp;
<a name="l00138"></a>00138                 <span class="stringliteral">&quot; is local: MPI sending boundary layer &quot;</span>, i1,i2,j1,j2,k1,k2, &amp;
<a name="l00139"></a>00139                 <span class="stringliteral">&quot; (&quot;</span>, nData, <span class="stringliteral">&quot; values) to rank &quot;</span>, destOwner
<a name="l00140"></a>00140               <span class="keyword">end if</span>
<a name="l00141"></a>00141 <span class="comment">! DEBUG</span>
<a name="l00142"></a>00142             <span class="keyword">else</span>
<a name="l00143"></a>00143               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00144"></a>00144                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;I don&#39;t own neighbor&quot;</span>, srcID, <span class="stringliteral">&quot;-&quot;</span>, srcOwner, <span class="stringliteral">&quot; does&quot;</span>
<a name="l00145"></a>00145               <span class="keyword">end if</span>
<a name="l00146"></a>00146 <span class="comment">! DEBUG</span>
<a name="l00147"></a>00147             <span class="keyword">end if</span>
<a name="l00148"></a>00148           <span class="keyword">end if</span>
<a name="l00149"></a>00149           
<a name="l00150"></a>00150           <span class="comment">! =================================</span>
<a name="l00151"></a>00151 
<a name="l00152"></a>00152           <span class="comment">! Boundary to finer block (source is coarser than destination)</span>
<a name="l00153"></a>00153           
<a name="l00154"></a>00154           <span class="keyword">if</span> (ntype.eq.NEIGH_COARSER) <span class="keyword">then</span>
<a name="l00155"></a>00155             srcID = neighs(1)
<a name="l00156"></a>00156             call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00157"></a>00157             <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00158"></a>00158             
<a name="l00159"></a>00159               <span class="comment">! Send one quarter of boundary layer through MPI</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161               call <a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite </a>(direction, src_face)
<a name="l00162"></a>00162               depth1 = (depth+1)/2   <span class="comment">! INT division</span>
<a name="l00163"></a>00163               call <a class="code" href="admesh_8f90.html#a5b56f8f8fd532b838ccd6a38f356ac8a">siblingCoords </a>(destID, sx, sy, sz)
<a name="l00164"></a>00164               call <a class="code" href="boundary_8f90.html#a26ba6756082058d69c55189dada54c16">quadrantLimits </a>(src_face, depth1, .false., sx, sy, sz, i1, i2, j1, j2, k1, k2)
<a name="l00165"></a>00165               call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00166"></a>00166 
<a name="l00167"></a>00167               nData = (i2-i1+1)*(j2-j1+1)*(k2-k1+1)*neqtot
<a name="l00168"></a>00168               call MPI_SEND ( uvars(srcInd, 1:neqtot, i1:i2, j1:j2, k1:k2), &amp;
<a name="l00169"></a>00169                nData, mpi_real_kind, destOwner, srcID, mpi_comm_world, ierr)
<a name="l00170"></a>00170 
<a name="l00171"></a>00171               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00172"></a>00172                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3,a,i6,a,i3)&#39;</span>) srcID, &amp;
<a name="l00173"></a>00173                 <span class="stringliteral">&quot; is local: MPI sending boundary quadrant &quot;</span>, i1,i2,j1,j2,k1,k2, &amp;
<a name="l00174"></a>00174                 <span class="stringliteral">&quot; (&quot;</span>, nData, <span class="stringliteral">&quot; values) to rank &quot;</span>, destOwner
<a name="l00175"></a>00175               <span class="keyword">end if</span>
<a name="l00176"></a>00176 <span class="comment">! DEBUG</span>
<a name="l00177"></a>00177             <span class="keyword">else</span>
<a name="l00178"></a>00178               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00179"></a>00179                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;I don&#39;t own neighbor&quot;</span>, srcID, <span class="stringliteral">&quot;-&quot;</span>, srcOwner, <span class="stringliteral">&quot; does&quot;</span>
<a name="l00180"></a>00180               <span class="keyword">end if</span>
<a name="l00181"></a>00181 <span class="comment">! DEBUG</span>
<a name="l00182"></a>00182             <span class="keyword">end if</span>
<a name="l00183"></a>00183           <span class="keyword">end if</span>
<a name="l00184"></a>00184 
<a name="l00185"></a>00185           <span class="comment">! =================================</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187           <span class="comment">! Boundary to coarser block (source is finer than destination)</span>
<a name="l00188"></a>00188           <span class="comment">! Will send up to 4 block boundaries</span>
<a name="l00189"></a>00189           
<a name="l00190"></a>00190           <span class="keyword">if</span> (ntype.eq.NEIGH_FINER) <span class="keyword">then</span>
<a name="l00191"></a>00191           
<a name="l00192"></a>00192             <span class="keyword">do</span> b=1,4 
<a name="l00193"></a>00193               srcID = neighs(b)
<a name="l00194"></a>00194               call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00195"></a>00195               <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00196"></a>00196               
<a name="l00197"></a>00197                 <span class="comment">! Average groups of eight cells into buffer before sending</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 call <a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite </a>(direction, src_face)
<a name="l00200"></a>00200                 depth1 = depth*2
<a name="l00201"></a>00201                 call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(src_face, depth1, .false., i1, i2, j1, j2, k1, k2)
<a name="l00202"></a>00202                 call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00203"></a>00203 
<a name="l00204"></a>00204                 <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00205"></a>00205                 <span class="keyword">case</span> (LEFT, RIGHT)
<a name="l00206"></a>00206                   x_buf = 0.0
<a name="l00207"></a>00207                 <span class="keyword">case</span> (FRONT, BACK)
<a name="l00208"></a>00208                   y_buf = 0.0
<a name="l00209"></a>00209                 <span class="keyword">case</span> (BOTTOM, TOP)
<a name="l00210"></a>00210                   z_buf = 0.0
<a name="l00211"></a>00211                 <span class="keyword">end select</span>
<a name="l00212"></a>00212 
<a name="l00213"></a>00213                 <span class="keyword">do</span> ieq=1,neqtot
<a name="l00214"></a>00214                   <span class="keyword">do</span> i=i1,i2
<a name="l00215"></a>00215                     <span class="keyword">do</span> j=j1,j2
<a name="l00216"></a>00216                       <span class="keyword">do</span> k=k1,k2
<a name="l00217"></a>00217                         ip = (i+1)/2
<a name="l00218"></a>00218                         jp = (j+1)/2
<a name="l00219"></a>00219                         kp = (k+1)/2
<a name="l00220"></a>00220                         <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00221"></a>00221                         <span class="keyword">case</span> (LEFT, RIGHT)
<a name="l00222"></a>00222                           ip = (i-i1+2)/2
<a name="l00223"></a>00223                           x_buf(ieq,ip,jp,kp) = x_buf(ieq,ip,jp,kp) + uvars(srcInd,ieq,i,j,k)/8.0
<a name="l00224"></a>00224                         <span class="keyword">case</span> (FRONT, BACK)
<a name="l00225"></a>00225                           jp = (j-j1+2)/2
<a name="l00226"></a>00226                           y_buf(ieq,ip,jp,kp) = y_buf(ieq,ip,jp,kp) + uvars(srcInd,ieq,i,j,k)/8.0
<a name="l00227"></a>00227                         <span class="keyword">case</span> (BOTTOM, TOP)
<a name="l00228"></a>00228                           kp = (k-k1+2)/2
<a name="l00229"></a>00229                           z_buf(ieq,ip,jp,kp) = z_buf(ieq,ip,jp,kp) + uvars(srcInd,ieq,i,j,k)/8.0
<a name="l00230"></a>00230                         <span class="keyword">end select</span>
<a name="l00231"></a>00231                       <span class="keyword">end do</span>
<a name="l00232"></a>00232                     <span class="keyword">end do</span>
<a name="l00233"></a>00233                   <span class="keyword">end do</span>
<a name="l00234"></a>00234                 <span class="keyword">end do</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236               <span class="comment">! Now send averaged cells in buffer through MPI</span>
<a name="l00237"></a>00237               
<a name="l00238"></a>00238               nData = ((i2-i1+1)/2)*((j2-j1+1)/2)*((k2-k1+1)/2)*neqtot
<a name="l00239"></a>00239               <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00240"></a>00240               <span class="keyword">case</span> (LEFT, RIGHT)
<a name="l00241"></a>00241                 call MPI_SEND ( x_buf, nData, mpi_real_kind, destOwner, &amp;
<a name="l00242"></a>00242                   srcID, mpi_comm_world, ierr)
<a name="l00243"></a>00243                 <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;Averaged values range: &quot;</span>, minval(x_buf), maxval(x_buf)
<a name="l00244"></a>00244               <span class="keyword">case</span> (FRONT, BACK)
<a name="l00245"></a>00245                 call MPI_SEND ( y_buf, nData, mpi_real_kind, destOwner, &amp;
<a name="l00246"></a>00246                   srcID, mpi_comm_world, ierr)
<a name="l00247"></a>00247                 <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;Averaged values range: &quot;</span>, minval(x_buf), maxval(x_buf)
<a name="l00248"></a>00248               <span class="keyword">case</span> (BOTTOM, TOP)
<a name="l00249"></a>00249                 call MPI_SEND ( z_buf, nData, mpi_real_kind, destOwner, &amp;
<a name="l00250"></a>00250                   srcID, mpi_comm_world, ierr)
<a name="l00251"></a>00251                 <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;Averaged values range: &quot;</span>, minval(x_buf), maxval(x_buf)
<a name="l00252"></a>00252               <span class="keyword">end select</span>
<a name="l00253"></a>00253 
<a name="l00254"></a>00254               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00255"></a>00255                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3,a,i6,a,i3)&#39;</span>) srcID, &amp;
<a name="l00256"></a>00256                 <span class="stringliteral">&quot; is local: MPI sending averaged boundary layer &quot;</span>, i1,i2,j1,j2,k1,k2, &amp;
<a name="l00257"></a>00257                 <span class="stringliteral">&quot; (&quot;</span>, nData, <span class="stringliteral">&quot; values) to rank &quot;</span>, destOwner
<a name="l00258"></a>00258               <span class="keyword">end if</span>
<a name="l00259"></a>00259 <span class="comment">! DEBUG</span>
<a name="l00260"></a>00260             <span class="keyword">else</span>
<a name="l00261"></a>00261               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00262"></a>00262                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;I don&#39;t own neighbor&quot;</span>, srcID, <span class="stringliteral">&quot;-&quot;</span>, srcOwner, <span class="stringliteral">&quot; does&quot;</span>
<a name="l00263"></a>00263               <span class="keyword">end if</span>
<a name="l00264"></a>00264 <span class="comment">! DEBUG </span>
<a name="l00265"></a>00265               <span class="keyword">end if</span>
<a name="l00266"></a>00266             <span class="keyword">end do</span>
<a name="l00267"></a>00267             
<a name="l00268"></a>00268           <span class="keyword">end if</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270           <span class="comment">! No SENDER-side operations involved in ntype=NEIGH_BOUNDARY</span>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="keyword">end if</span>
<a name="l00273"></a>00273 
<a name="l00274"></a>00274         <span class="comment">! ======================== !</span>
<a name="l00275"></a>00275         <span class="comment">! Receiver-side operations !</span>
<a name="l00276"></a>00276         <span class="comment">! ======================== !</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <span class="comment">! Performed when destination block is LOCAL</span>
<a name="l00279"></a>00279         <span class="keyword">if</span> (destOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00280"></a>00280 
<a name="l00281"></a>00281           <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;I own the destination block&quot;</span>
<a name="l00282"></a>00282 
<a name="l00283"></a>00283           <span class="comment">! =================================</span>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285           <span class="comment">! Boundary from same-level block</span>
<a name="l00286"></a>00286           
<a name="l00287"></a>00287           <span class="keyword">if</span> (ntype.eq.NEIGH_SAME) <span class="keyword">then</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289             srcID = neighs(1)
<a name="l00290"></a>00290             call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00291"></a>00291             call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(direction, depth, .true., i1, i2, j1, j2, k1, k2)
<a name="l00292"></a>00292             call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(destID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, destInd)
<a name="l00293"></a>00293 
<a name="l00294"></a>00294             <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296               <span class="comment">! LOCAL boundary; ghost cells are copied one-to-one</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298               call <a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite </a>(direction, src_face)
<a name="l00299"></a>00299               call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(src_face, depth, .false., i3, i4, j3, j4, k3, k4)
<a name="l00300"></a>00300               call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00301"></a>00301               uvars(destInd, 1:neqtot, i1:i2, j1:j2, k1:k2) = uvars(srcInd, 1:neqtot, i3:i4, j3:j4, k3:k4)
<a name="l00302"></a>00302 
<a name="l00303"></a>00303               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00304"></a>00304                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3,a,i3,i3,i3,i3,i3,i3)&#39;</span>) srcID, &amp;
<a name="l00305"></a>00305                 <span class="stringliteral">&quot; is local too: copying SRC boundary layer &quot;</span>, i3,i4,j3,j4,k3,k4, &amp;
<a name="l00306"></a>00306                 <span class="stringliteral">&quot; into DEST ghost layer &quot;</span>, i1,i2,j1,j2,k1,k2
<a name="l00307"></a>00307               <span class="keyword">end if</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309             <span class="keyword">else</span>
<a name="l00310"></a>00310             
<a name="l00311"></a>00311               <span class="comment">! NONLOCAL boundary; ghost cells are received one-to-one through MPI</span>
<a name="l00312"></a>00312               
<a name="l00313"></a>00313               nData = (i2-i1+1)*(j2-j1+1)*(k2-k1+1)*neqtot
<a name="l00314"></a>00314               call MPI_RECV ( uvars(destInd, 1:neqtot, i1:i2, j1:j2, k1:k2), nData, &amp;
<a name="l00315"></a>00315                 mpi_real_kind, srcOwner, srcID, mpi_comm_world, mpi_status, ierr)
<a name="l00316"></a>00316 
<a name="l00317"></a>00317               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00318"></a>00318                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i8,a,i6,a,i3,i3,i3,i3,i3,i3)&#39;</span>) srcID, &amp;
<a name="l00319"></a>00319                 <span class="stringliteral">&quot; is owned by rank &quot;</span>, srcOwner, <span class="stringliteral">&quot; : receiving MPI data (&quot;</span>, nData, &amp;
<a name="l00320"></a>00320                 <span class="stringliteral">&quot; values) into boundary layer &quot;</span>, i1,i2,j1,j2,k1,k2
<a name="l00321"></a>00321               <span class="keyword">end if</span>
<a name="l00322"></a>00322 
<a name="l00323"></a>00323             <span class="keyword">end if</span>
<a name="l00324"></a>00324             
<a name="l00325"></a>00325           <span class="keyword">end if</span>
<a name="l00326"></a>00326           
<a name="l00327"></a>00327           <span class="comment">! =================================</span>
<a name="l00328"></a>00328           
<a name="l00329"></a>00329           <span class="comment">! Boundary from coarser block (source is coarser than destination)</span>
<a name="l00330"></a>00330           
<a name="l00331"></a>00331           <span class="keyword">if</span> (ntype.eq.NEIGH_COARSER) <span class="keyword">then</span>
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             srcID = neighs(1)
<a name="l00334"></a>00334             call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00335"></a>00335             call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(direction, depth, .true., i1, i2, j1, j2, k1, k2)
<a name="l00336"></a>00336             call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(destID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, destInd)
<a name="l00337"></a>00337 
<a name="l00338"></a>00338             <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340               <span class="comment">! LOCAL boundary; ghost cells are calculated with duplicated data</span>
<a name="l00341"></a>00341               
<a name="l00342"></a>00342               call <a class="code" href="admesh_8f90.html#a5b56f8f8fd532b838ccd6a38f356ac8a">siblingCoords </a>(destID, sx, sy, sz)
<a name="l00343"></a>00343               call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00344"></a>00344               <span class="keyword">do</span> ieq=1,neqtot
<a name="l00345"></a>00345                 <span class="keyword">do</span> i=i1,i2
<a name="l00346"></a>00346                   <span class="keyword">do</span> j=j1,j2
<a name="l00347"></a>00347                     <span class="keyword">do</span> k=k1,k2
<a name="l00348"></a>00348                       ip = (i+1)/2 + sx*ncells_x/2
<a name="l00349"></a>00349                       jp = (j+1)/2 + sy*ncells_y/2
<a name="l00350"></a>00350                       kp = (k+1)/2 + sz*ncells_z/2
<a name="l00351"></a>00351                       <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00352"></a>00352                       <span class="keyword">case</span> (LEFT)
<a name="l00353"></a>00353                         ip = ncells_x + (i+1)/2
<a name="l00354"></a>00354                       <span class="keyword">case</span> (RIGHT)
<a name="l00355"></a>00355                         ip = (i-ncells_x+1)/2
<a name="l00356"></a>00356                       <span class="keyword">case</span> (FRONT)
<a name="l00357"></a>00357                         jp = ncells_y + (j+1)/2
<a name="l00358"></a>00358                       <span class="keyword">case</span> (BACK)
<a name="l00359"></a>00359                         jp = (j-ncells_y+1)/2
<a name="l00360"></a>00360                       <span class="keyword">case</span> (BOTTOM)
<a name="l00361"></a>00361                         kp = ncells_z + (k+1)/2
<a name="l00362"></a>00362                       <span class="keyword">case</span> (TOP)
<a name="l00363"></a>00363                         kp = (k-ncells_z+1)/2
<a name="l00364"></a>00364                       <span class="keyword">end select</span>
<a name="l00365"></a>00365                       uvars(destInd, ieq, i, j, k) = uvars(srcInd, ieq, ip, jp, kp)
<a name="l00366"></a>00366                     <span class="keyword">end do</span>
<a name="l00367"></a>00367                   <span class="keyword">end do</span>
<a name="l00368"></a>00368                 <span class="keyword">end do</span>
<a name="l00369"></a>00369               <span class="keyword">end do</span>
<a name="l00370"></a>00370 
<a name="l00371"></a>00371               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00372"></a>00372                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3)&#39;</span>) srcID, &amp;
<a name="l00373"></a>00373                 <span class="stringliteral">&quot; is local too: multiplying SRC boundary layer into DEST ghost layer &quot;</span>, &amp;
<a name="l00374"></a>00374                 i1,i2,j1,j2,k1,k2
<a name="l00375"></a>00375               <span class="keyword">end if</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377             <span class="keyword">else</span>
<a name="l00378"></a>00378 
<a name="l00379"></a>00379               <span class="comment">! NONLOCAL boundary; ghost cells received into buffer and duplicated</span>
<a name="l00380"></a>00380 
<a name="l00381"></a>00381               <span class="comment">! Receive a quadrant of boundary cells into appropriate buffer</span>
<a name="l00382"></a>00382               depth1 = (depth+1)/2
<a name="l00383"></a>00383               <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00384"></a>00384               <span class="keyword">case</span> (LEFT, RIGHT)
<a name="l00385"></a>00385                 nData = neqtot*depth1*ncells_y/2*ncells_z/2
<a name="l00386"></a>00386                 call MPI_RECV ( x_buf(1:neqtot, 1:depth1, 1:ncells_y/2, 1:ncells_z/2), &amp;
<a name="l00387"></a>00387                   nData, mpi_real_kind, srcOwner, srcID, mpi_comm_world, mpi_status, ierr)
<a name="l00388"></a>00388               <span class="keyword">case</span> (FRONT, BACK)
<a name="l00389"></a>00389                 nData = neqtot*ncells_x/2*depth1*ncells_z/2
<a name="l00390"></a>00390                 call MPI_RECV ( y_buf(1:neqtot, 1:ncells_x/2, 1:depth1, 1:ncells_z/2), &amp;
<a name="l00391"></a>00391                   nData, mpi_real_kind, srcOwner, srcID, mpi_comm_world, mpi_status, ierr)
<a name="l00392"></a>00392               <span class="keyword">case</span> (BOTTOM, TOP)
<a name="l00393"></a>00393                 nData = neqtot*ncells_x/2*ncells_y/2*depth1
<a name="l00394"></a>00394                 call MPI_RECV ( z_buf(1:neqtot, 1:ncells_x/2, 1:ncells_y/2, 1:depth1), &amp;
<a name="l00395"></a>00395                   nData, mpi_real_kind, srcOwner, srcID, mpi_comm_world, mpi_status, ierr)
<a name="l00396"></a>00396               <span class="keyword">end select</span>
<a name="l00397"></a>00397 
<a name="l00398"></a>00398               <span class="comment">! Set ghost cells with duplicated data</span>
<a name="l00399"></a>00399               call <a class="code" href="admesh_8f90.html#a5b56f8f8fd532b838ccd6a38f356ac8a">siblingCoords </a>(destID, sx, sy, sz)
<a name="l00400"></a>00400               <span class="keyword">do</span> ieq=1,neqtot
<a name="l00401"></a>00401                 <span class="keyword">do</span> i=i1,i2
<a name="l00402"></a>00402                   <span class="keyword">do</span> j=j1,j2
<a name="l00403"></a>00403                     <span class="keyword">do</span> k=k1,k2
<a name="l00404"></a>00404                       ip = (i+1)/2
<a name="l00405"></a>00405                       jp = (j+1)/2
<a name="l00406"></a>00406                       kp = (k+1)/2
<a name="l00407"></a>00407                       <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00408"></a>00408                       <span class="keyword">case</span> (LEFT)
<a name="l00409"></a>00409                         ip = (2-i)/2
<a name="l00410"></a>00410                       <span class="keyword">case</span> (RIGHT)
<a name="l00411"></a>00411                         ip = (i-ncells_x+1)/2
<a name="l00412"></a>00412                       <span class="keyword">case</span> (FRONT)
<a name="l00413"></a>00413                         jp = (2-j)/2
<a name="l00414"></a>00414                       <span class="keyword">case</span> (BACK)
<a name="l00415"></a>00415                         jp = (j-ncells_y+1)/2
<a name="l00416"></a>00416                       <span class="keyword">case</span> (BOTTOM)
<a name="l00417"></a>00417                         kp = (2-k)/2
<a name="l00418"></a>00418                       <span class="keyword">case</span> (TOP)
<a name="l00419"></a>00419                         kp = (k-ncells_z+1)/2
<a name="l00420"></a>00420                       <span class="keyword">end select</span>
<a name="l00421"></a>00421                       <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00422"></a>00422                       <span class="keyword">case</span> (LEFT, RIGHT)
<a name="l00423"></a>00423                         uvars(destInd, ieq, i, j, k) = x_buf(ieq, ip, jp, kp)
<a name="l00424"></a>00424                       <span class="keyword">case</span> (FRONT, BACK)
<a name="l00425"></a>00425                         uvars(destInd, ieq, i, j, k) = y_buf(ieq, ip, jp, kp)
<a name="l00426"></a>00426                       <span class="keyword">case</span> (BOTTOM, TOP)
<a name="l00427"></a>00427                         uvars(destInd, ieq, i, j, k) = z_buf(ieq, ip, jp, kp)
<a name="l00428"></a>00428                       <span class="keyword">end select</span>
<a name="l00429"></a>00429                     <span class="keyword">end do</span>
<a name="l00430"></a>00430                   <span class="keyword">end do</span>
<a name="l00431"></a>00431                 <span class="keyword">end do</span>
<a name="l00432"></a>00432               <span class="keyword">end do</span>
<a name="l00433"></a>00433 
<a name="l00434"></a>00434               <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00435"></a>00435                 <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i8,a,i6,a,i3,i3,i3,i3,i3,i3)&#39;</span>) srcID, &amp;
<a name="l00436"></a>00436                 <span class="stringliteral">&quot; is owned by rank &quot;</span>, srcOwner, <span class="stringliteral">&quot; : receiving MPI data (&quot;</span>, nData, &amp;
<a name="l00437"></a>00437                 <span class="stringliteral">&quot; values) into buffer and duplicating into boundary layer &quot;</span>, &amp;
<a name="l00438"></a>00438                 i1,i2,j1,j2,k1,k2
<a name="l00439"></a>00439               <span class="keyword">end if</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441             <span class="keyword">end if</span>
<a name="l00442"></a>00442 
<a name="l00443"></a>00443           <span class="keyword">end if</span>
<a name="l00444"></a>00444 
<a name="l00445"></a>00445           <span class="comment">! =================================</span>
<a name="l00446"></a>00446 
<a name="l00447"></a>00447           <span class="comment">! Boundary from four finer blocks (source is finer than destination)</span>
<a name="l00448"></a>00448           
<a name="l00449"></a>00449           <span class="keyword">if</span> (ntype.eq.NEIGH_FINER) <span class="keyword">then</span>
<a name="l00450"></a>00450 
<a name="l00451"></a>00451             <span class="comment">! Set all ghost cells to zero</span>
<a name="l00452"></a>00452             call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(destID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, destInd)
<a name="l00453"></a>00453             call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(direction, depth, .true., i1, i2, j1, j2, k1, k2)
<a name="l00454"></a>00454             uvars(destInd,:,i1:i2,j1:j2,k1:k2) = 0.0
<a name="l00455"></a>00455 
<a name="l00456"></a>00456             <span class="comment">! For each of the four neighbor blocks ...</span>
<a name="l00457"></a>00457             <span class="keyword">do</span> b=1,4 
<a name="l00458"></a>00458 
<a name="l00459"></a>00459               srcID = neighs(b)
<a name="l00460"></a>00460               call <a class="code" href="admesh_8f90.html#a5423257f930e1a76bcf559ca03bf74c6">getOwner </a>(srcID, srcOwner)
<a name="l00461"></a>00461               
<a name="l00462"></a>00462               <span class="keyword">if</span> (srcOwner.eq.<a class="code" href="namespaceglobals.html#a93f283242b146b3ef8b53fd1b1ad7bac">rank</a>) <span class="keyword">then</span>
<a name="l00463"></a>00463 
<a name="l00464"></a>00464                 <span class="comment">! LOCAL boundary: SRC boundary cells are averaged into DEST ghost cells</span>
<a name="l00465"></a>00465                 
<a name="l00466"></a>00466                 call <a class="code" href="admesh_8f90.html#a5b56f8f8fd532b838ccd6a38f356ac8a">siblingCoords </a>(srcID, sx, sy, sz)
<a name="l00467"></a>00467                 call <a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite </a>(direction, src_face)
<a name="l00468"></a>00468                 depth1 = depth*2
<a name="l00469"></a>00469                 call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(src_face, depth1, .false., i3, i4, j3, j4, k3, k4)
<a name="l00470"></a>00470                 call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(srcID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, srcInd)
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                 <span class="keyword">do</span> ieq=1,neqtot
<a name="l00473"></a>00473                   <span class="keyword">do</span> i=i3,i4
<a name="l00474"></a>00474                     <span class="keyword">do</span> j=j3,j4
<a name="l00475"></a>00475                       <span class="keyword">do</span> k=k3,k4
<a name="l00476"></a>00476                         ip = (i+1)/2 + sx*ncells_x/2
<a name="l00477"></a>00477                         jp = (j+1)/2 + sy*ncells_y/2
<a name="l00478"></a>00478                         kp = (k+1)/2 + sz*ncells_z/2
<a name="l00479"></a>00479                         <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00480"></a>00480                         <span class="keyword">case</span> (LEFT)
<a name="l00481"></a>00481                           ip = (i-ncells_x)/2
<a name="l00482"></a>00482                         <span class="keyword">case</span> (RIGHT)
<a name="l00483"></a>00483                           ip = (i+1)/2 + ncells_x
<a name="l00484"></a>00484                         <span class="keyword">case</span> (FRONT)
<a name="l00485"></a>00485                           jp = (j-ncells_y)/2
<a name="l00486"></a>00486                         <span class="keyword">case</span> (BACK)
<a name="l00487"></a>00487                           jp = (j+1)/2 + ncells_y
<a name="l00488"></a>00488                         <span class="keyword">case</span> (BOTTOM)
<a name="l00489"></a>00489                           kp = (k-ncells_z)/2
<a name="l00490"></a>00490                         <span class="keyword">case</span> (TOP)
<a name="l00491"></a>00491                           kp = (k+1)/2 + ncells_z
<a name="l00492"></a>00492                         <span class="keyword">end select</span>
<a name="l00493"></a>00493                         uvars(destInd,ieq,ip,jp,kp) = uvars(destInd,ieq,ip,jp,kp) + uvars(srcInd,ieq,i,j,k)/8.0
<a name="l00494"></a>00494                       <span class="keyword">end do</span>
<a name="l00495"></a>00495                     <span class="keyword">end do</span>
<a name="l00496"></a>00496                   <span class="keyword">end do</span>
<a name="l00497"></a>00497                 <span class="keyword">end do</span>                
<a name="l00498"></a>00498 
<a name="l00499"></a>00499                 <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00500"></a>00500                   <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i3,i3,i3,i3,i3,i3,a)&#39;</span>) srcID, &amp;
<a name="l00501"></a>00501                   <span class="stringliteral">&quot; is local too: averaging SRC boundary layer &quot;</span>, i3,i4,j3,j4,k3,k4, &amp;
<a name="l00502"></a>00502                   <span class="stringliteral">&quot; into DEST ghost layer&quot;</span>
<a name="l00503"></a>00503                 <span class="keyword">end if</span>
<a name="l00504"></a>00504                 
<a name="l00505"></a>00505               <span class="keyword">else</span>
<a name="l00506"></a>00506 
<a name="l00507"></a>00507                 <span class="comment">! NONLOCAL boundary; pre-averaged ghost cells received directly into DEST quadrant</span>
<a name="l00508"></a>00508 
<a name="l00509"></a>00509                 call <a class="code" href="admesh_8f90.html#a5b56f8f8fd532b838ccd6a38f356ac8a">siblingCoords </a>(srcID, sx, sy, sz)
<a name="l00510"></a>00510                 call <a class="code" href="boundary_8f90.html#a26ba6756082058d69c55189dada54c16">quadrantLimits </a>(direction, depth, .true., sx, sy, sz, i1, i2, j1, j2, k1, k2)
<a name="l00511"></a>00511                 nData = (i2-i1+1)*(j2-j1+1)*(k2-k1+1)*neqtot
<a name="l00512"></a>00512                 call MPI_RECV ( uvars(destInd, 1:neqtot, i1:i2, j1:j2, k1:k2), nData, &amp;
<a name="l00513"></a>00513                   mpi_real_kind, srcOwner, srcID, mpi_comm_world, mpi_status, ierr)
<a name="l00514"></a>00514 
<a name="l00515"></a>00515                 <span class="keyword">if</span> (verbose) <span class="keyword">then</span>
<a name="l00516"></a>00516                   <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,i8,a,i8,a,i6,a,i3,i3,i3,i3,i3,i3)&#39;</span>) srcID, &amp;
<a name="l00517"></a>00517                   <span class="stringliteral">&quot; is owned by rank &quot;</span>, srcOwner, <span class="stringliteral">&quot; : receiving MPI data (&quot;</span>, nData, &amp;
<a name="l00518"></a>00518                   <span class="stringliteral">&quot; values) into boundary layer &quot;</span>, i1,i2,j1,j2,k1,k2
<a name="l00519"></a>00519                 <span class="keyword">end if</span>
<a name="l00520"></a>00520   
<a name="l00521"></a>00521               <span class="keyword">end if</span>
<a name="l00522"></a>00522           
<a name="l00523"></a>00523             <span class="keyword">end do</span>
<a name="l00524"></a>00524             
<a name="l00525"></a>00525           <span class="keyword">end if</span>
<a name="l00526"></a>00526 
<a name="l00527"></a>00527           <span class="comment">! =================================</span>
<a name="l00528"></a>00528 
<a name="l00529"></a>00529           <span class="comment">! Computational domain boundary</span>
<a name="l00530"></a>00530           <span class="comment">! Calculate ghost cells locally (except PERIODIC BCs)</span>
<a name="l00531"></a>00531 
<a name="l00532"></a>00532           <span class="comment">! Pick the corresponding BC for this direction</span>
<a name="l00533"></a>00533           <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00534"></a>00534           <span class="keyword">case</span> (LEFT)
<a name="l00535"></a>00535             bc_type = bc_left
<a name="l00536"></a>00536           <span class="keyword">case</span> (RIGHT)
<a name="l00537"></a>00537             bc_type = bc_right
<a name="l00538"></a>00538           <span class="keyword">case</span> (FRONT)
<a name="l00539"></a>00539             bc_type = bc_front
<a name="l00540"></a>00540           <span class="keyword">case</span> (BACK)
<a name="l00541"></a>00541             bc_type = bc_back
<a name="l00542"></a>00542           <span class="keyword">case</span> (BOTTOM)
<a name="l00543"></a>00543             bc_type = bc_bottom
<a name="l00544"></a>00544           <span class="keyword">case</span> (TOP)
<a name="l00545"></a>00545             bc_type = bc_top
<a name="l00546"></a>00546           <span class="keyword">case</span> default
<a name="l00547"></a>00547             <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,*) <span class="stringliteral">&quot;INVALID BC TYPE=&quot;</span>, bc_type
<a name="l00548"></a>00548             exit
<a name="l00549"></a>00549           <span class="keyword">end select</span>
<a name="l00550"></a>00550           
<a name="l00551"></a>00551           <span class="keyword">if</span> ((ntype.eq.NEIGH_BOUNDARY).and.(bc_type.ne.BC_PERIODIC)) <span class="keyword">then</span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553             <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(1x,a)&#39;</span>) <span class="stringliteral">&quot;Computional domain boundary: calculating locally&quot;</span>
<a name="l00554"></a>00554 
<a name="l00555"></a>00555             call <a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits </a>(direction, depth, .true., i1, i2, j1, j2, k1, k2)
<a name="l00556"></a>00556             call <a class="code" href="utils_8f90.html#a2f2f03814c3471b9a0797e2f03655c68">find </a>(destID, <a class="code" href="namespaceglobals.html#adc845521f6ad2502bc19df43607224e0">localBlocks</a>, nbMaxProc, destInd)
<a name="l00557"></a>00557 
<a name="l00558"></a>00558             <span class="comment">! For every ghost cell ...</span>
<a name="l00559"></a>00559             <span class="keyword">do</span> i=i1,i2
<a name="l00560"></a>00560               <span class="keyword">do</span> j=j1,j2
<a name="l00561"></a>00561                 <span class="keyword">do</span> k=k1,k2
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                   ip = i
<a name="l00564"></a>00564                   jp = j
<a name="l00565"></a>00565                   kp = k
<a name="l00566"></a>00566                   <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00567"></a>00567                   <span class="keyword">case</span> (LEFT)
<a name="l00568"></a>00568                     ip = 1 - i
<a name="l00569"></a>00569                   <span class="keyword">case</span> (RIGHT)
<a name="l00570"></a>00570                     ip = 2*ncells_x - i + 1
<a name="l00571"></a>00571                   <span class="keyword">case</span> (FRONT)
<a name="l00572"></a>00572                     jp = 1 - j
<a name="l00573"></a>00573                   <span class="keyword">case</span> (BACK)
<a name="l00574"></a>00574                     jp = 2*ncells_y - j + 1
<a name="l00575"></a>00575                   <span class="keyword">case</span> (BOTTOM)
<a name="l00576"></a>00576                     kp = 1 - k
<a name="l00577"></a>00577                   <span class="keyword">case</span> (TOP)
<a name="l00578"></a>00578                     kp = 2*ncells_z - k + 1
<a name="l00579"></a>00579                   <span class="keyword">end select</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                   <span class="comment">! Reflective (one component of velocity flips sign)</span>
<a name="l00582"></a>00582                   <span class="keyword">if</span> (bc_type.eq.BC_REFLECTIVE) <span class="keyword">then</span>
<a name="l00583"></a>00583                   
<a name="l00584"></a>00584                     <span class="keyword">do</span> ieq=1,neqtot
<a name="l00585"></a>00585                       <span class="keyword">if</span> (((direction.eq.LEFT).or.(direction.eq.RIGHT)).and.(ieq.eq.2)) <span class="keyword">then</span>
<a name="l00586"></a>00586                         uvars(destInd,2,i,j,k) = -1.0 * uvars(destInd,2,ip,jp,kp)
<a name="l00587"></a>00587                       <span class="keyword">else</span> <span class="keyword">if</span> (((direction.eq.FRONT).or.(direction.eq.BACK)).and.(ieq.eq.3)) <span class="keyword">then</span>
<a name="l00588"></a>00588                         uvars(destInd,3,i,j,k) = -1.0 * uvars(destInd,3,ip,jp,kp)
<a name="l00589"></a>00589                       <span class="keyword">else</span> <span class="keyword">if</span> (((direction.eq.BOTTOM).or.(direction.eq.TOP)).and.(ieq.eq.4)) <span class="keyword">then</span>
<a name="l00590"></a>00590                         uvars(destInd,4,i,j,k) = -1.0 * uvars(destInd,4,ip,jp,kp)
<a name="l00591"></a>00591                       <span class="keyword">else</span>
<a name="l00592"></a>00592                         uvars(destInd,ieq,i,j,k) = uvars(destInd,ieq,ip,jp,kp)
<a name="l00593"></a>00593                       <span class="keyword">end if</span>
<a name="l00594"></a>00594                     <span class="keyword">end do</span>
<a name="l00595"></a>00595 
<a name="l00596"></a>00596                   <span class="comment">! Free flow (zero gradient - copy cells)</span>
<a name="l00597"></a>00597                   <span class="keyword">else</span> <span class="keyword">if</span> (bc_type.eq.BC_FREE_FLOW) <span class="keyword">then</span>
<a name="l00598"></a>00598                
<a name="l00599"></a>00599                     uvars(destInd,:,i,j,k) = uvars(destInd,:,ip,jp,kp)
<a name="l00600"></a>00600 
<a name="l00601"></a>00601                   <span class="comment">! Periodic BCs are handled as block BCs (the neighbors function</span>
<a name="l00602"></a>00602                   <span class="comment">! returns the correct neighbor in this case</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604                   <span class="comment">! Special BCs are problem-specific</span>
<a name="l00605"></a>00605                   <span class="comment">! TODO: a mechanism to set these, possibly by calling a</span>
<a name="l00606"></a>00606                   <span class="comment">! subroutine provided by the IC module</span>
<a name="l00607"></a>00607                   <span class="keyword">else</span> <span class="keyword">if</span> (bc_type.eq.BC_SPECIAL) <span class="keyword">then</span>
<a name="l00608"></a>00608                   
<a name="l00609"></a>00609                   <span class="keyword">end if</span>
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 
<a name="l00612"></a>00612                 <span class="keyword">end do</span>
<a name="l00613"></a>00613               <span class="keyword">end do</span>
<a name="l00614"></a>00614             <span class="keyword">end do</span>
<a name="l00615"></a>00615             
<a name="l00616"></a>00616           <span class="keyword">end if</span>
<a name="l00617"></a>00617 
<a name="l00618"></a>00618           <span class="comment">! =================================</span>
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="keyword">end if</span>
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="comment">! DEBUG</span>
<a name="l00623"></a>00623       <span class="keyword">if</span> (verbose) <span class="keyword">write</span>(<a class="code" href="namespaceglobals.html#a5baaf3368c41942a3e5e48a39b97c2ce">logu</a>,<span class="stringliteral">&#39;(a,i8)&#39;</span>) <span class="stringliteral">&quot;Done with block&quot;</span>, destID
<a name="l00624"></a>00624 <span class="comment">! DEBUG</span>
<a name="l00625"></a>00625 
<a name="l00626"></a>00626       <span class="keyword">end if</span>     
<a name="l00627"></a>00627     <span class="keyword">end do</span>
<a name="l00628"></a>00628     
<a name="l00629"></a>00629   <span class="keyword">end do</span>
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="keyword">end subroutine boundary</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">!===============================================================================</span>
<a name="l00634"></a>00634 <span class="comment"></span>
<a name="l00635"></a>00635 !&gt; @brief Computes the limits (min/max i-j-k values) of boundary or ghost cell layers
<a name="l00636"></a>00636 !&gt; @param face The face the layer is on
<a name="l00637"></a>00637 !&gt; @param depth The number of boundary cell layers
<a name="l00638"></a>00638 !&gt; @param ghost Are these limits meant for ghost cells?
<a name="l00639"></a>00639 !&gt; @param imin The minimum i-value
<a name="l00640"></a>00640 !&gt; @param imax The maximum i-value
<a name="l00641"></a>00641 !&gt; @param jmin The minimum j-value
<a name="l00642"></a>00642 !&gt; @param jmax The maximum j-value
<a name="l00643"></a>00643 !&gt; @param kmin The minimum k-value
<a name="l00644"></a>00644 !&gt; @param kmax The maximum k-value
<a name="l00645"></a><a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">00645</a> <span class="keyword">subroutine </span><a class="code" href="boundary_8f90.html#a9c4f3712297b58096169db09064c9d87">layerLimits</a> (face, depth, ghost, imin, imax, jmin, jmax, kmin, kmax)
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   use <span class="keywordflow">parameters</span>
<a name="l00648"></a>00648   <span class="keyword">implicit none</span>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: face
<a name="l00651"></a>00651   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: depth
<a name="l00652"></a>00652   <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: ghost
<a name="l00653"></a>00653   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: imin, imax, jmin, jmax, kmin, kmax
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <span class="comment">! Set full range initially ...</span>
<a name="l00656"></a>00656   imin = 1
<a name="l00657"></a>00657   imax = <a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a>
<a name="l00658"></a>00658   jmin = 1
<a name="l00659"></a>00659   jmax = <a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a>
<a name="l00660"></a>00660   kmin = 1
<a name="l00661"></a>00661   kmax = <a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a>
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="comment">! ... then crop along depth direction</span>
<a name="l00664"></a>00664   <span class="keyword">select</span> <span class="keyword">case</span> (face)
<a name="l00665"></a>00665   <span class="keyword">case</span> (LEFT)
<a name="l00666"></a>00666     imax = depth
<a name="l00667"></a>00667   <span class="keyword">case</span> (RIGHT)
<a name="l00668"></a>00668     imin = <a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a> - depth + 1
<a name="l00669"></a>00669   <span class="keyword">case</span> (FRONT)
<a name="l00670"></a>00670     jmax = depth
<a name="l00671"></a>00671   <span class="keyword">case</span> (BACK)
<a name="l00672"></a>00672     jmin = <a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a> - depth + 1
<a name="l00673"></a>00673   <span class="keyword">case</span> (BOTTOM)
<a name="l00674"></a>00674     kmax = depth
<a name="l00675"></a>00675   <span class="keyword">case</span> (TOP)
<a name="l00676"></a>00676     kmin = <a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a> - depth + 1
<a name="l00677"></a>00677   <span class="keyword">case</span> default
<a name="l00678"></a>00678     <span class="comment">! Should abort execution</span>
<a name="l00679"></a>00679   <span class="keyword">end select</span>
<a name="l00680"></a>00680 
<a name="l00681"></a>00681   <span class="comment">! If these are ghost cells, shift them accordingly</span>
<a name="l00682"></a>00682   <span class="keyword">if</span> (ghost) <span class="keyword">then</span>
<a name="l00683"></a>00683     <span class="keyword">select</span> <span class="keyword">case</span> (face)
<a name="l00684"></a>00684     <span class="keyword">case</span> (LEFT)
<a name="l00685"></a>00685       imin = imin - depth
<a name="l00686"></a>00686       imax = imax - depth
<a name="l00687"></a>00687     <span class="keyword">case</span> (RIGHT)
<a name="l00688"></a>00688       imin = imin + depth
<a name="l00689"></a>00689       imax = imax + depth
<a name="l00690"></a>00690     <span class="keyword">case</span> (FRONT)
<a name="l00691"></a>00691       jmin = jmin - depth
<a name="l00692"></a>00692       jmax = jmax - depth
<a name="l00693"></a>00693     <span class="keyword">case</span> (BACK)
<a name="l00694"></a>00694       jmin = jmin + depth
<a name="l00695"></a>00695       jmax = jmax + depth      
<a name="l00696"></a>00696     <span class="keyword">case</span> (BOTTOM)
<a name="l00697"></a>00697       kmin = kmin - depth
<a name="l00698"></a>00698       kmax = kmax - depth
<a name="l00699"></a>00699     <span class="keyword">case</span> (TOP)
<a name="l00700"></a>00700       kmin = kmin + depth
<a name="l00701"></a>00701       kmax = kmax + depth
<a name="l00702"></a>00702     <span class="keyword">case</span> default
<a name="l00703"></a>00703       <span class="comment">! Should abort execution</span>
<a name="l00704"></a>00704     <span class="keyword">end select</span>
<a name="l00705"></a>00705   <span class="keyword">end if</span>
<a name="l00706"></a>00706   
<a name="l00707"></a>00707   return
<a name="l00708"></a>00708 
<a name="l00709"></a>00709 <span class="keyword">end subroutine layerLimits</span>
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 <span class="comment">!====================================================================</span>
<a name="l00712"></a>00712 <span class="comment"></span>
<a name="l00713"></a>00713 !&gt; @brief Computes the limits of a subquadrant of a layer of boundary or ghost cells
<a name="l00714"></a>00714 !&gt; @param face The face the layer is on
<a name="l00715"></a>00715 !&gt; @param depth The number of boundary cell layers
<a name="l00716"></a>00716 !&gt; @param ghost Are these limits meant for ghost cells?
<a name="l00717"></a>00717 !&gt; @param sx The shift of the quadrant along x (0 or 1)
<a name="l00718"></a>00718 !&gt; @param sy The shift of the quadrant along y (0 or 1)
<a name="l00719"></a>00719 !&gt; @param sz The shift of the quadrant along z (0 or 1)
<a name="l00720"></a>00720 !&gt; @param imin The minimum i-value
<a name="l00721"></a>00721 !&gt; @param imax The maximum i-value
<a name="l00722"></a>00722 !&gt; @param jmin The minimum j-value
<a name="l00723"></a>00723 !&gt; @param jmax The maximum j-value
<a name="l00724"></a>00724 !&gt; @param kmin The minimum k-value
<a name="l00725"></a>00725 !&gt; @param kmax The maximum k-value
<a name="l00726"></a><a class="code" href="boundary_8f90.html#a26ba6756082058d69c55189dada54c16">00726</a> <span class="keyword">subroutine </span><a class="code" href="boundary_8f90.html#a26ba6756082058d69c55189dada54c16">quadrantLimits</a> (face, depth, ghost, sx, sy, sz, imin, imax, jmin, jmax, kmin, kmax)
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   use <span class="keywordflow">parameters</span>
<a name="l00729"></a>00729   <span class="keyword">implicit none</span>
<a name="l00730"></a>00730 
<a name="l00731"></a>00731   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: face
<a name="l00732"></a>00732   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: depth
<a name="l00733"></a>00733   <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: ghost
<a name="l00734"></a>00734   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: sx, sy, sz
<a name="l00735"></a>00735   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: imin, imax, jmin, jmax, kmin, kmax
<a name="l00736"></a>00736 
<a name="l00737"></a>00737   <span class="comment">! Set to correct full octant ...</span>
<a name="l00738"></a>00738   imin = 1 + (<a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a>/2)*sx
<a name="l00739"></a>00739   imax = (<a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a>/2)*(sx+1)
<a name="l00740"></a>00740   jmin = 1 + (<a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a>/2)*sy
<a name="l00741"></a>00741   jmax = (<a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a>/2)*(sy+1)
<a name="l00742"></a>00742   kmin = 1 + (<a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a>/2)*sz
<a name="l00743"></a>00743   kmax = (<a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a>/2)*(sz+1)
<a name="l00744"></a>00744 
<a name="l00745"></a>00745   <span class="comment">! ... then crop in depth direction</span>
<a name="l00746"></a>00746   <span class="keyword">select</span> <span class="keyword">case</span> (face)
<a name="l00747"></a>00747   <span class="keyword">case</span> (LEFT)
<a name="l00748"></a>00748     imin = 1
<a name="l00749"></a>00749     imax = depth
<a name="l00750"></a>00750   <span class="keyword">case</span> (RIGHT)
<a name="l00751"></a>00751     imin = <a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a> - depth + 1
<a name="l00752"></a>00752     imax = <a class="code" href="namespaceparameters.html#ad032cf1de9e7d232d045a52ece9eae4b">ncells_x</a>
<a name="l00753"></a>00753   <span class="keyword">case</span> (FRONT)
<a name="l00754"></a>00754     jmin = 1
<a name="l00755"></a>00755     jmax = depth
<a name="l00756"></a>00756   <span class="keyword">case</span> (BACK)
<a name="l00757"></a>00757     jmin = <a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a> - depth + 1
<a name="l00758"></a>00758     jmax = <a class="code" href="namespaceparameters.html#aa52d0561bd220fc5f155b7d1932d8f1d">ncells_y</a>
<a name="l00759"></a>00759   <span class="keyword">case</span> (BOTTOM)
<a name="l00760"></a>00760     kmin = 1
<a name="l00761"></a>00761     kmax = depth
<a name="l00762"></a>00762   <span class="keyword">case</span> (TOP)
<a name="l00763"></a>00763     kmin = <a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a> - depth + 1
<a name="l00764"></a>00764     kmax = <a class="code" href="namespaceparameters.html#a568fe0267a053f4e31fc851dba5a1ede">ncells_z</a>
<a name="l00765"></a>00765   <span class="keyword">case</span> default
<a name="l00766"></a>00766     <span class="comment">! Should abort execution</span>
<a name="l00767"></a>00767   <span class="keyword">end select</span>
<a name="l00768"></a>00768   
<a name="l00769"></a>00769   <span class="comment">! If these are ghost cells, shift them accordingly</span>
<a name="l00770"></a>00770   <span class="keyword">if</span> (ghost) <span class="keyword">then</span>
<a name="l00771"></a>00771     <span class="keyword">select</span> <span class="keyword">case</span> (face)
<a name="l00772"></a>00772     <span class="keyword">case</span> (LEFT)
<a name="l00773"></a>00773       imin = imin - depth
<a name="l00774"></a>00774       imax = imax - depth
<a name="l00775"></a>00775     <span class="keyword">case</span> (RIGHT)
<a name="l00776"></a>00776       imin = imin + depth
<a name="l00777"></a>00777       imax = imax + depth
<a name="l00778"></a>00778     <span class="keyword">case</span> (FRONT)
<a name="l00779"></a>00779       jmin = jmin - depth
<a name="l00780"></a>00780       jmax = jmax - depth
<a name="l00781"></a>00781     <span class="keyword">case</span> (BACK)
<a name="l00782"></a>00782       jmin = jmin + depth
<a name="l00783"></a>00783       jmax = jmax + depth      
<a name="l00784"></a>00784     <span class="keyword">case</span> (BOTTOM)
<a name="l00785"></a>00785       kmin = kmin - depth
<a name="l00786"></a>00786       kmax = kmax - depth
<a name="l00787"></a>00787     <span class="keyword">case</span> (TOP)
<a name="l00788"></a>00788       kmin = kmin + depth
<a name="l00789"></a>00789       kmax = kmax + depth
<a name="l00790"></a>00790     <span class="keyword">case</span> default
<a name="l00791"></a>00791       <span class="comment">! Should abort execution</span>
<a name="l00792"></a>00792     <span class="keyword">end select</span>
<a name="l00793"></a>00793   <span class="keyword">end if</span>
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="keyword">end subroutine quadrantLimits</span>
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="comment">!===============================================================================</span>
<a name="l00798"></a>00798 <span class="comment"></span>
<a name="l00799"></a>00799 !&gt; @brief Returns the direction opposite of &#39;direction&#39;
<a name="l00800"></a>00800 !&gt; @param direction Given direction
<a name="l00801"></a>00801 !&gt; @param opposite Opposite direction
<a name="l00802"></a><a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">00802</a> <span class="keyword">subroutine </span><a class="code" href="boundary_8f90.html#a0c901d92b8c790f5e1ebe8fbb7962e2e">opposite</a> (direction, oppDir)
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   use <span class="keywordflow">parameters</span>
<a name="l00805"></a>00805   <span class="keyword">implicit none</span>
<a name="l00806"></a>00806 
<a name="l00807"></a>00807   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: direction
<a name="l00808"></a>00808   <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: oppDir
<a name="l00809"></a>00809 
<a name="l00810"></a>00810   <span class="keyword">select</span> <span class="keyword">case</span> (direction)
<a name="l00811"></a>00811   <span class="keyword">case</span> (LEFT)
<a name="l00812"></a>00812     oppDir = RIGHT
<a name="l00813"></a>00813   <span class="keyword">case</span> (RIGHT)
<a name="l00814"></a>00814     oppDir = LEFT
<a name="l00815"></a>00815   <span class="keyword">case</span> (FRONT)
<a name="l00816"></a>00816     oppDir = BACK
<a name="l00817"></a>00817   <span class="keyword">case</span> (BACK)
<a name="l00818"></a>00818     oppDir = FRONT
<a name="l00819"></a>00819   <span class="keyword">case</span> (BOTTOM)
<a name="l00820"></a>00820     oppDir = TOP
<a name="l00821"></a>00821   <span class="keyword">case</span> (TOP)
<a name="l00822"></a>00822     oppDir = BOTTOM
<a name="l00823"></a>00823   <span class="keyword">case</span> default
<a name="l00824"></a>00824     <span class="comment">! SHOULD ABORT EXECUTION</span>
<a name="l00825"></a>00825   <span class="keyword">end select</span>
<a name="l00826"></a>00826 
<a name="l00827"></a>00827   return
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 <span class="keyword">end subroutine opposite</span>
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 <span class="comment">!===============================================================================</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Thu Jun 7 13:53:13 2012 for Walicxe3D by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
